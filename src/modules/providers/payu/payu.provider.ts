import crypto from 'crypto';import { Injectable } from '@nestjs/common';import { HttpClient } from '../../../common/http.client';import { VaultService } from '../../../common/vault.service';import { retry } from '../../../common/retry';import { IPaymentProvider } from '../types/ipayment-provider';function sha512(s){return crypto.createHash('sha512').update(s).digest('hex');}function timingEqualSafe(a,b){try{const A=Buffer.from(a);const B=Buffer.from(b);if(A.length!==B.length)return false;return crypto.timingSafeEqual(A,B);}catch{return false;}}@Injectable()export class PayuProvider implements IPaymentProvider{constructor(private http:HttpClient,private vault:VaultService){}name(){return 'payu';}private async creds(){const key=await this.vault.get('providers/payu','key')||process.env.PAYU_KEY;const salt=await this.vault.get('providers/payu','salt')||process.env.PAYU_SALT;if(!key||!salt)throw new Error('PayU credentials missing');return{key,salt};}async createPayment(input){const{key,salt}=await this.creds();const txnid=input.orderId;const amount=input.amount.toFixed(2);const productinfo='ORDER';const email=input.customer.email||'test@example.com';const firstname=input.customer.name||'Customer';const parts=[key,txnid,amount,productinfo,firstname,email,'','','','','','','',salt];const hash=sha512(parts.join('|'));const data={key,txnid,amount,productinfo,firstname,email,phone:input.customer.phone||'',surl:'https://example.com/success',furl:'https://example.com/fail',hash};return{id:txnid,status:'created',data};}async capturePayment(pid,amount){const call=async()=>({id:pid,status:'captured',data:{amount}});const data=await retry(call,3,400);return{id:pid,status:data.status,data};}async verifyWebhook({body}){const salt=process.env.WEBHOOK_SALT_PAYU||'';if(!body||!body.hash)return{ok:false,data:body};const fields=[salt,body.status,'','','','','','','','',body.email,body.firstname,'ORDER',body.amount,body.txnid,body.key];const hash=sha512(fields.join('|'));const ok=timingEqualSafe(hash,body.hash);return{ok,providerPaymentId:body?.mihpayid,orderId:body?.txnid,status:body?.status,data:body};}}