import { Injectable, NestMiddleware, UnauthorizedException } from '@nestjs/common';import { PrismaService } from '../modules/db/prisma.service';@Injectable()export class ApiKeyMiddleware implements NestMiddleware{constructor(private prisma:PrismaService){}async use(req:any,res:any,next:any){const key=req.headers['x-api-key']||req.query.api_key; if(!key) return next(); const row=await this.prisma.apiKey.findUnique({ where:{ key } }); if(!row || row.revoked) throw new UnauthorizedException('Invalid API key'); req.merchant={ id: row.merchantId }; next(); }}